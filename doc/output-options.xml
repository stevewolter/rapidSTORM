<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE reference 
[<!ENTITY % isogrk1 PUBLIC "ISO 8879:1986//ENTITIES Greek Letters//EN//XML"
                    "http://www.oasis-open.org/docbook/xmlcharent/0.3/iso-grk1.ent">
 <!ENTITY % isopub PUBLIC "ISO 8879:1986//ENTITIES Publishing//EN//XML"
                    "http://www.oasis-open.org/docbook/xmlcharent/0.3/iso-pub.ent">
%isogrk1;
%isopub;
]>

<chapter id="output_modules" xmlns='http://docbook.org/ns/docbook' xml:lang="en" xmlns:et="http://super-resolution.de/elemtable">
   <title>Output options</title>

   <para>
     This chapter is dedicated to the description of the different
     output modules that can be inserted into the output tree. Each of
     these modules will be defined by a general description of its purpose
     and its mode of operations, a table of the configuration options it
     will display in job options window (if any), 
     and a table of the configuration
     options it will display in the job status window (if any).</para>

   <refentry id="localizations_file_output">
      <refnamediv>
         <refname>Localizations file</refname> 
      </refnamediv>
      <refsection><title>Synopsis</title>
        <para>The localizations file module stores received localizations
            in an ASCII text file. This text file is line-based with one line
            per localization and one line header information. Both the header 
            line and localization lines consist of at least 4 space-delimited
            fields. For the localizations, the fields denote X and Y position
            in pixels, the image number of the localization and the strength
            of the localization (Gaussian fit amplitude) in camera A/D counts.
            The header consists of the maximum allowed X/Y coordinates and
            image number and of a 0 for the amplitude.</para>
        <para>More fields may be present, but will not be documented.
            Forward compatibility can be achieved by ignoring all but the first
            four fields.</para>
     </refsection>
     <refsection>
        <title>Configuration items</title>
        <et:elemtable>
            <et:elem desc="Write localizations to" topic="Table_ToFile">
            <para>Output localizations file name. Is derived automatically from
                input file name.</para>
            </et:elem>
        </et:elemtable>
     </refsection>
   </refentry>

   <refentry id="image_display">
        <refnamediv><refname>Image display</refname></refnamediv>
        <refsection><title>Synopsis</title>
            <para>The image display module displays all received localizations in
            an image and optionally saves this image to a file.</para>
        </refsection>
        <refsection>
            <title>Image construction algorithm</title>
            <para>The image construction is performed with the algorithm documented
                in <xref linkend="WolterDiplomarbeit"/>. Summarizing this algorithm,
                a localization density map is constructed by linearly interpolating
                and accumulating the localizations, weighted by their amplitude,
                on a pixel lattice.
                This density map is discretized with a very high depth to generate
                a high dynamic range image; this high-dynamic range image is reduced
                to a displayable range via weighted histogram equalization.</para>
            <para>The histogram equalization operation modifies the absolute
                brightness differences between image areas to optimize contrast.
                This means that a pixel in the result image with a brightness of
                200 did not necessarily receive twice as many localizations as a
                pixel with brightness 100 did. Histogram equalizations guarantees
                only that a brighter pixel represents at least as many localizations
                as a weaker pixel.</para>
            <para>You can change the extent to which histogram equalization is
                performed by changing the histogram equalization power between
                0 and 1. 0 means no histogram equalization, and pixel values are
                linear with localization density. 1 means full equalization: All
                brightness values appear equally often in the image. While images
                without histogram equalization aplied often suffer in contrast due
                to few, very bright pixels suppressing the normal structures, too
                much histogram equalization overemphasises regions with weak signals
                and background noise. The default value for the histogram power is
                usually a good compromise.</para>
        </refsection>
     <refsection id="color_coding">
       <title>Color coding</title>
       <para>Several different coloring schemes are available for the
         resulting image. All of these operate on the histogram-normalized
         brightness, but display the brightness in various ways to enhance
         information
         depth, produce a pretty-looking image or give information about the
         time coordinate. All of these color schemes show brighter colors
         to indicate more localizations; to invert this meaning and show,
         for example, black localizations on a white background, use the
         "Invert colours" option.</para>
       <para>The <emphasis>black and white</emphasis> colour scheme is the
         fastest colour code. It displays the equalized brightness directly
         on a scale ranging from black (no localizations) to white (maximum
         amount).</para>
       <para>The <emphasis>black, red, yellow and white</emphasis> colour
         scheme offers a higher dynamic range by displaying the lowest
         third of the brightness values on a scale ranging from black to
         red, the middle third on a scale from red to yellow and the highest
         third on a scale from yellow to white. In total, about 760
         brightness levels are displayed.</para>
       <para>The <emphasis>constant colour</emphasis> colour
         scheme is similar to the black-and-white scheme, but uses an
         arbitray colour instead of white. You can use the "Select colour
         hue" and "Select saturation" to choose the colour.</para>
       <para>The <emphasis>Vary hue by time coordinate</emphasis> colour
         scheme colour-codes each localization by its time coordinate, that
         is, by the number  of the image it occured in. The code starts at
         the
         hue selected in "Select colour hue" and then follows the colour
         circle of the HSV colour model, that is, ranges from red over
         yellow, green, cyan, blue to violet.
         If multiple localizations contribute to the same pixel, hue and
         variance are interpreted as angle and radius on a plane, converted
         to cartesian coordinates, averaged arithmetically and converted
         back to hue and variance.
         For example, if red (hue 0, 
         saturation 1) and yellow-green (hue 0.25, saturation 1) are present
         with amplitudes 1 and 4 on a pixel, they are
         converted to the points (1,0) and (0,1), averaged to (0.2,0.8) and
         transformed back to (hue 0.21, saturation 0.82), which is a slightly
         pale yellow. Observe that a point with localizations equally 
         distributed over a long range of images tends to have a low
         saturation, that is, appear white.</para>
     </refsection>
     <refsection>
       <title>Changing parameters after starting a job</title>
       <para>If a <xref linkend="repeater"/> service is available through a
         parent module, most image display parameters can be changed even
         after the job is started.</para>
     </refsection>
     <refsection>
        <title>Configuration items</title>
        <et:elemtable>
            <et:elem desc="Save image to" topic="Viewer_ToFile">
                <para>If a filename is given here, the final result image will be saved
                    to the given file. The file extension determines the file type, and all
                    common file formats (GIF, JPG, PNG, TIF) are supported.</para>
            </et:elem>
            <et:elem desc="Display dSTORM result image" topic="Viewer_ShowOutput">
                <para>If this checkbox is checked, the result image will be shown online
                    in an image window. Disable for faster computation.</para>
            </et:elem>
            <et:elem desc="Resolution Enhancement" topic="Viewer_ResEnh">
                <para>Set the aspect ratio of source (camera detector) pixels to target
                    pixels. If set to 10, for example, the result image will be have 10
                    times more pixels in X direction and 10 times more pixels in Y
                    direction.</para></et:elem>
            <et:elem desc="Color palette for display" topic="Viewer_ColorScheme">
                <para>Select one of the color schemes given in <xref 
                    linkend="color_coding"/>.</para>
            </et:elem>
            <et:elem desc="Invert colors" topic="Viewer_InvertColors">
                <para>Invert the color display. Each color is inverted among the three
                    primary color axes (red, green, blue), making red to cyan and
                    black to white.</para>
            </et:elem>
            <et:elem desc="Select color hue"  topic="Viewer_Hue">
                <para>Set the hue for constant color coding or the starting hue for
                    variable hueing. Ranges from 0 (red) over 1/6 (yellow), 1/3
                    (green), 1/2 (cyan), 2/3 (blue) and 5/6 (violet) to 1 (red again).</para>
            </et:elem>
            <et:elem desc="Select saturation" topic="Viewer_Saturation">
                <para>Set the saturation for constant color coding. Ranges from 
                    0 (no colors at all, only grey) to 1 (fully saturated colors).</para>
            </et:elem>
        </et:elemtable>
     </refsection>
     <refsection>
       <title>Job status items</title>
        <et:elemtable>
            <et:elem desc="Resolution enhancement" topic="Viewer_Status_ResEnh" >
                <para>Shows the current resolution enhancement (see job options table
                for a definition) and allows, if a 
                <xref linkend="repeater"/> service is present, to dynamically
                change it.</para>
            </et:elem>

            <et:elem desc="Extent of histogram normalization" topic="Viewer_Status_Power">
                <para>Interactively change the intensity scale of the result image from
                    a linear scale (value 0) to a contrast-enhanced image (value 1).</para>
            </et:elem>

            <et:elem desc="Zoom level" topic="Viewer_Status_Zoom">
                <para>Control element for zooming in (positive values) or out (negative
                    values) in the displayed image.</para>
            </et:elem>

            <et:elem desc="Save image to" topic="Viewer_Status_ToFile">
                <para>Shows and changes the file name where the result image should be
                    written to. The file extension determines the file type, and all
                    common file formats (GIF, JPG, PNG, TIF) are supported.</para>
            </et:elem>

            <et:elem desc="Save image" topic="Viewer_Status_Save">
                <para>Save the image at the current state of computation to the file given
                    by <guilabel><xref linkend="Viewer_Status_ToFile"/></guilabel>.</para>
            </et:elem>

        </et:elemtable>
     </refsection>
   </refentry>

   <refentry id="count_localizations"> 
      <refnamediv><refname>Count localizations</refname></refnamediv>
        <refsection><title>Synopsis</title>
            <para>This output module outputs a count of all received localizations.</para>
        </refsection>
        <refsection>
            <title>Job status items</title>
            <et:elemtable>
                <et:elem desc="Number of localizations found" topic="Count_Count">
                    <para>Displays the total number of localizations propagated by the parent
                        module.</para></et:elem>
            </et:elemtable>
        </refsection>
   </refentry>

   <refentry id="MemoryCache">
      <refnamediv><refname>Memory Cache</refname></refnamediv>
      <refsection><title>Synopsis</title>
        <para>This output module stores all its input localizations in the computer's 
            main memory. It provides a <xref linkend="repeater"/> service to its submodules,
            enabling features like interactive range selection in the image viewer, but
            also does not store the source images, preventing modules like 
            <xref linkend="estimate_psf_form"/> from working as submodules of this module.</para>
      </refsection>
   </refentry>

   <refentry> 
      <refnamediv><refname>Slice localization set</refname>
                  <refpurpose>Split the input along the time axis to make a movie</refpurpose></refnamediv>
      <refsection><title>Synopsis</title>
         <para>This output module can automatically slice one input acquisition
            into a number of output acquisitions, each of which is processed
            seperately.</para>
         <para>After determining the number of slices, this module makes one
            copy of its children output modules for each slice. Each copy will
            receive only the localizations in its slice. To keep memory usage
            low, the copies will be made on demand, when the first localization
            of a slice arrives, and will be closed as soon as the last localization
            of its slice has been processed.</para>
      </refsection>
     <refsection>
         <title>Configuration items</title>
         <et:elemtable>
            <et:elem desc="Size of one slice in images" topic="Slicer_Size">
               <para>Each slice will have as many images as specified here.
                Suppose slices in an acquisition 1000 images long start at
                0, 300, 600 and 900 and this parameter is set to 500, there
                will be the four slices 0-499, 300-799, 600-999 and 900-999.</para>
            </et:elem>
            <et:elem desc="Start new slice every n images" topic="Slicer_Dist">
               <para>One slice will be started at each image number 
                divisible by this number. Suppose 1000 images are in an
                acquisition and this parameter is set to 300, slices will
                be started at images 0, 300, 600 and 900.</para>
            </et:elem>
            <et:elem desc="File name pattern" topic="Slicer_Pattern">
               <para>Pattern for output file basenames. The output files (for example
                for images or localization files) will be generated by this pattern,
                where %i will be replaced with the slice number.</para>
            </et:elem>
         </et:elemtable>
      </refsection>
   </refentry>

   <refentry> 
      <refnamediv><refname>Average images</refname></refnamediv>
      <para>This module does not process localizations, but rather averages
        all source images it receives to produce one averaged image. This
        image can be used to see how the specimen would have looked without
        dSTORM processing.</para>
      <para><note>This module will only work when source images are 
        available.</note>
        Source images are unavailable for children, direct or
        indirect, of the <xref linkend="MemoryCache"/> module or
        if the input comes from the <xref linkend="STM"/> file type.</para>
     <refsection>
        <title>Configuration items</title>
        <et:elemtable>
            <et:elem desc="Write averaged image to" topic="AverageImage_ToFile">
                <para>Target file to write the gained average image to. 
                The file extension determines the file type, and all
                common file formats (GIF, JPG, PNG, TIF) are supported.</para></et:elem>
        </et:elemtable>
     </refsection>
   </refentry>
   <refentry> 
      <refnamediv><refname>Display progress</refname></refnamediv>
      <para>Show a progress bar to indicate state of computation.</para>
      <refsection>
         <title>Job status items</title>
         <et:elemtable>
               <et:elem desc="Progress on this job" topic="ProgressMeter_Progress">
                  <para>This progress bar shows the progress on the current job, that is,
                  which percentage of the input images has been successfully
                  computed.</para></et:elem>
         </et:elemtable>
      </refsection>
   </refentry>

   <refentry id="estimate_psf_form">
      <refnamediv><refname>Estimate PSF form</refname></refnamediv>
      <refsection>
         <title>Synopsis</title>
      </refsection>
      <refsection>
         <title>Configuration items</title>
         <et:elemtable>
            <et:elem topic="EstimatePSF_FormMLE" desc="Use MLE to fit PSF form">
                <para>Optimize for maximum likelihood (ML) of the data with the optimized model
                instead of minimizing the squared deviations. You should use the same distance
                model for fitting the PSF as you configured in the engine.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_EstimationSpots" desc="Number of spots used in estimation">
                <para>This option configures the total number of spots that are used to fit the PSF
                form. Localizations are scanned and presented until this number of spots is
                selected.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_MaxEstimationSpotsPerImage" desc="Number of spots used per image">
                <para>This option configures the maximum number of spots that are eligible for estimation
                in each source image. The spots with the highest amplitude are selected, the rest
                is discarded and not shown in the selection window. If this number is exceeded, the
                rest of the spots in an image is not displayed. A fractional number can be entered
                in this field, translating to one spot being picked in each n-th frame. For example,
                a value of 0.25 selects one spot every fourth frame.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_SelectSpots" desc="Manually select good spots">
                <para>If this option is checked, the selection window (as described above) is shown. Otherwise,
                all eligible spots are used in estimation.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_LaempiPosition" desc="Laempi fit for positions">
                <para>When fitting multiple layers, fit fluorophore positions in all layers independently.
                This can mitigate an imprecise plane alignment at the cost of reduced precision.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_LaempiAmplitudes" desc="Disjoint amplitude fit">
                <para>When fitting multiple layers, fit intensities in all layers independently.
                This allows fitting a multi-plane data set without knowing the prefactors
                or making assumptions about fluorophore populations, at the cost of reduced
                precision and the inability to fit transmission coefficients.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_ZIsTruth" desc="Z position is ground truth">
                <para>Treat the fluorophore's Z position as ground truth, i.e. do not fit it. This
                option is useful when calibrating polynomial 3D and in conjunction with setting
                a ground-truth Z position in the <xref linkend="ExpressionFilter"/> output.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_FitWindowWidth" desc="Fit window radius">
                <para>Include all pixels into the fit window that are closer than this radius to the
                selected spot. This is currently an L1 distance.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_CircularPSF" desc="Assume circular PSF">
                <para>Assume that the PSF has the same parameters in X and Y, and fit these parameters
                in common. Enhances estimation precision and stability at the cost of flexibility and thruthful
                replication of the PSF.
                This option applies to PSF width and 3D widening factors, but not to the
                focus plane coordinates, which are controlled by <xref linkend="EstimatePSF_Astigmatism"/></para>
            </et:elem>
            <et:elem topic="EstimatePSF_Astigmatism" desc="Allow astigmatism">
                <para>Allow the X and Y focal planes to differ. If this option is unchecked, both planes
                are set to the same value and fitted together. Checking this option allows fitting
                data on an astigmatic 3D setup, e.g. with a cylindrical lens.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_UniversalBestSigma" desc="PSF FWHM common to all layers">
                <para>Assume that the PSF FWHM is the same in all layers, and fit it as a common coordinate.
                This option is related, but orthogonal to <xref linkend="EstimatePSF_CircularPSF"/>.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_UniversalWidening" desc="3D widening common to all layers">
                <para>Assume that the polynomial 3D widening parameters are the same in all layers, and fit 
                them as common coordinates.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_FitBestSigma" desc="Fit PSF FWHM">
                <para>When this option is checked, the width of the PSF will be fitted to the data. 
                Otherwise, it will be treated as ground truth and not changed. If the PSF FWHM has
                been established reliably on other measurements, disabling this option enhances
                estimation stability and reliability.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_FitFocusPlane" desc="Fit focus plane Z coordinate">
                <para>When this option is checked, the Z position of the best-focused planes (i.e. the Z
                positions at which the X and Y PSF FWHMs are smallest, respectively) will be fitted
                to the data.</para>
            </et:elem>
            <et:elem topic="EstimatePSF_FitPrefactors" desc="Fit transmission factors">
                <para>When this option is checked, the fluorophore transmission factors are fitted to the
                data. This allows for straightforward multi-color calibration on live data.</para>
            </et:elem>
        </et:elemtable>
      </refsection>
   </refentry>

   <refentry id="SigmaDiff3D">
      <refnamediv><refname>Look up 3D via sigma difference</refname></refnamediv>
      <refsection>
         <title>Synopsis</title>
         <para>This output sets the Z position on its input localizations by computing the
               difference between the X and Y PSF widths and looking up the difference in the
               provided <xref linkend="z_calibration_table"/>. Thereby, a Z coordinate can be
               estimated on data that have been fitted with free PSF widths. For more information,
               see <xref linkend="Henriques2010"/>.</para>
         <para>It is preferable to provide the <xref linkend="z_calibration_table"/> directly
               to the fitting module by choosing the <et:elemref linkend="Spline3D"/> as <et:elemref linkend="ThreeD"/>.
               Thereby, a degree of fitting freedom is avoided and precision is enhanced.</para>
      </refsection>
      <refsection>
         <title>Configuration items</title>
         <et:elemtable>
            <et:elem desc="Calibration file" topic="SigmaDiff3D_CalibrationFile">
               <para>Input file name for the calibration table in which the difference is looked up.
               The format is described in <xref linkend="z_calibration_table"/>.</para>
            </et:elem>
         </et:elemtable>
      </refsection>
   </refentry>

   <refentry id="SigmaCurve">
      <refnamediv><refname>3D PSF width calibration table</refname></refnamediv>
      <refsection><title>Synopsis</title>
         <para>This output stores a <xref linkend="z_calibration_table"/> for the relationship between the
               Z position and the PSF widths. It assumes that the Z position and PSF widths are set on its
               input localizations, orders the input localizations, smoothes them with cubic B splines and
               stores the values at the control points in the calibration output file.</para>
      </refsection>
      <refsection>
         <title>Configuration items</title>
         <et:elemtable>
               <et:elem desc="Calibration output file" topic="SigmaCurve_ToFile">
                  <para>Output file name for calibration table. The format is
                  described in <xref linkend="z_calibration_table"/>.</para></et:elem>
               <et:elem desc="Number of B spline breakpoints" topic="SigmaCurve_StepNumber">
                  <para>Number of breakpoints to use for cubic B-spline interpolation. The number of
                  breakpoints determines the number of cubic pieces used to approximate the
                  measured PSF width curve. This number can be viewed as the adaptibility of the
                  sigma curve to the measured PSF widths.</para></et:elem>
         </et:elemtable>
      </refsection>
   </refentry>

   <refentry id="track_emissions"> 
      <refnamediv><refname>Track emissions</refname></refnamediv>
        <refsection><title>Synopsis</title>
         <para>This output uses <ulink url="http://en.wikipedia.org/wiki/Kalman_filter">Kalman filtering</ulink>
               to track and link spatially and temporally close localizations into a single localization.
               Most commonly, it's used when your camera frame rate is much higher than your switching rate,
               so that every fluorophore is on for many images and you want only a single, very precise position.
               It is also useful for drift correction.</para>
         <para>For every frame, the Kalman model computes the expected position and the position uncertainty for
             all known traces. Every localization that is within <et:elemref linkend="EmissionTracker_Distance_Threshold"/>
             confidence intervals of an active trace is appended to the active trace. All other localizations start
             new traces, with an initial expected position and uncertainty identical to the creating localization and an initial
             velocity of 0. The module uses a simple movement model consisting of position and velocity.</para>
         <para>When no localizations were added to a trace after more than <et:elemref linkend="EmissionTracker_Allow_Blinking"/>
             frames, the trace is considered inactive, and no further localizations are added to it.</para>
         <para>The module uses the localization fields for position uncertainty. Therefore, you don't give explicit distance
             thresholds, but rather the threshold in confidence intervals.</para>
         <para>As a simple example for the algorithm's operation, consider a case where both the mobility constant and the
             diffusion constant are zero, and all localizations have an uncertainty of 10 nm standard deviation. When the first
             localization is found at point 0, there is no active trace, so the localization creates a trace at point 0 with
             an uncertainty of 10 nm. When the second localization arrives, it also has an uncertainty of 10 nm, so their distance
             has an uncertainty of 14 nm. At a distance threshold of 2, this means that the two localizations are considered to
             belong to the same trace if they are closer than 28 nm. Suppose that the new localization belongs to the same trace.
             Now the position estimate for the trace is the average of the two localizations, and its uncertainty is 7 nm.
             When the third localization arrives, the localization has an uncertainty of 10 nm, the trace has 7 nm, so their distance
             has an uncertainty of 12 nm, and they are considered to belong to the same trace when they are closer than 24 nm.
             Over time, the uncertainty of the trace converges to 0, so the radius in which new localizations are added converges
             to the distance threshold times the localization uncertainty.</para>
         <para>As you have seen in the example, this module doesn't use a fixed radius for determining whether two localizations
             belong together. This is because we have a much better idea where the underlying fluorophore of a longer trace really is.
             Therefore, we can choose smaller radii for longer traces.</para>
         <para>If you want to use the localization tracker for very long traces, e.g. for tracking beads, it is advisable to add a
             diffusion constant. The diffusion constant allows small, temporarily uncorrelated movements for the particle or the
             microscope stage.</para>
        </refsection>
        <refsection>
            <title>Configuration items</title>
            <et:elemtable>
               <et:elem desc="Allowed blinking interval" topic="AllowBlinking">
                  <para>Time for which traces stay active even when they don't receive localizations. A value of 0 implies
                      that every active trace must receive one localization every frame, or go inactive. Setting this value
                      too high carries the danger of tracing unrelated localizations. 1 or 2 is usually a good
                      value.</para></et:elem>
               <et:elem desc="Distance threshold" topic="DistanceThreshold">
                  <para>Linking threshold in confidence intervals. If a new localization is at least this close to an established
                      trace, it's considered part of the trace. A value of 2 corresponds to a 95% confidence interval, i.e., 95%
                      of the localizations that actually are part of the trace are added to it.</para></et:elem>
               <et:elem desc="Diffusion constant" topic="DiffusionConstant">
                  <para>Magnitude of random displacement. If this parameter is non-zero, we assume that fluorophores are shifted
                      randomly between frames. This causes the model to give newer localizations more weight in the estimate
                      of the current position, and to always assume a minimum position uncertainty of the localization.
                      This parameter is useful for tracking beads, which almost always move a little.</para>
                  <para>In the model, the movement is assumed to be temporarily uncorrelated: Just because a fluorophore moved
                      to the left in the last frame, it doesn't mean that it will move to the left again.</para></et:elem>
               <et:elem desc="Mobility constant" topic="Mobility">
                  <para>Magnitude of random acceleration. If this parameter is non-zero, we assume that fluorophores experience
                      random velocity shifts between frames. If a fluorophore is observed to be moving to the right, the model
                      will assume that it will continue to do so.</para>
                  <para>This parameter is scarcely used, and its effects are unknown. It's there because it was trivial to
                      implement and shows the power of the Kalman model. Please send your success stories to the
                      mailing list.</para></et:elem>
            </et:elemtable>
        </refsection>
   </refentry>

   <refentry id="ExpressionFilter">
      <refnamediv><refname>Expression filter</refname></refnamediv>
      <refsection>
         <para>This output allows filtering on and changing individual localization fields.
                  It is distributed into two parts: The simple input fields for minimum localization
                  strength, linear drift correction and maximum two kernel improvement give easy
                  access to often-needed manipulations, while the more complex test-based expressions
                  give full access to all localization fields.</para>
         <para>The number of <guilabel>Value to assign to</guilabel> and <guilabel>Expression to assign from</guilabel> fields in this
               output is variable and can be changed with the <guilabel>Number of expressions</guilabel> field. These fields
               form pairs called "actions", and all of the actions take effect. The order of application is top-to-bottom.</para>
      </refsection>
      <refsection>
         <title>Configuration items</title>
         <et:elemtable>
               <et:elem desc="Minimum localization strength" topic="ExpressionFilter_LowerAmplitudeThreshold">
                  <para>If this field is enabled, all localizations with a strength lower than its value are
                  discarded and not displayed or stored in the suboutputs. The localization strength denotes
                  the total signal detected in the PSF, i.e. the integral of the point spread function.</para>
               </et:elem>
               <et:elem desc="Linear drift correction" topic="ExpressionFilter_LinearDriftCorrection">
                  <para>If this field is enabled, all localizations are shifted in space by an amount proportional
                  to the time coordinate of their detection. This is used to implement <xref linkend="linear_drift_correction"/>.</para>
               </et:elem>
               <et:elem desc="Maximum two kernel improvement" topic="ExpressionFilter_TwoKernelImprovement">
                  <para>If this field is checked, all localizations with a two-kernel improvement (quotient of residues
                  with two kernels and residues with one kernel) greater than the given value are discarded.
                  This value is used for artifact suppression and is only available when <guilabel>Compute two kernel improvement</guilabel>
                  has been checked.</para>
               </et:elem>
               <et:elem desc="Value to assign to" topic="ExpressionFilter_LValue">
                  <para>This option box determines the effect of the action. It can either take the value of <guilabel>Filter</guilabel>,
                  in which case <guilabel>Expression to assign from</guilabel> must give a boolean result,
                  or a variable name, in which case <guilabel>Expression to assign from</guilabel> must give a numerical result which matching dimensions.
                  The possible variable names are formed by applying the modifiers from <xref linkend="ExpressionFilter_VariableModifiers"/> to
                  <xref linkend="ExpressionFilter_VariableBasenames"/>, with examples in <xref linkend="ExpressionFilter_VariableExamples"/>.</para>
               </et:elem>
               <et:elem desc="Expression to assign from" topic="ExpressionFilter_Expression">
                  <para>This text field gives an arithmetic expression for the value of the action. An
                  expression consists of variables explained in <guilabel>Value to assign to</guilabel> and constants,
                  linked by the usual arithmetic operators. Constants are given as numbers with units, which
                  can be <userinput>m</userinput>, <userinput>ADC</userinput> or <userinput>fr</userinput> for
                  meters, camera A/D counts of frames, respectively, and be prefixed with the usual SI prefixes
                  (with <userinput>u</userinput> for &mgr;). The available operators are given in <xref linkend="ExpressionFilter_Operators"/>.
                  Examples for complete actions are listed in <xref linkend="ExpressionFilter_ExampleActions"/></para>
               </et:elem>
         </et:elemtable>
      </refsection>
      <table id="ExpressionFilter_VariableBasenames">
         <title>Variable base names for expressions</title>
         <tgroup cols='4' align='left' colsep='1' rowsep='1'>
               <colspec colnum="1" colwidth="6em"/>
               <colspec colnum="2" colwidth="7em"/>
               <colspec colnum="3" colwidth="5em"/>
               <thead><row><entry>Variable base name</entry><entry>Dimension</entry><entry>Type</entry><entry>Meaning</entry></row></thead>
               <tbody>
                  <row><entry>pos</entry><entry>m</entry><entry>3D vector</entry><entry>Position in sample space</entry></row>
                  <row><entry>amp</entry><entry>ADC</entry><entry>scalar</entry><entry>Intensity of emission</entry></row>
                  <row><entry>frame</entry><entry>fr</entry><entry>scalar</entry><entry>Time of emission</entry></row>
                  <row><entry>psffwhm</entry><entry>m</entry><entry>2D vector</entry><entry>PSF model's full width at half maximum</entry></row>
                  <row><entry>fishy</entry><entry>dimensionless</entry><entry>scalar</entry><entry>Two-kernel improvement</entry></row>
                  <row><entry>chisq</entry><entry>dimensionless</entry><entry>scalar</entry><entry>Fit residues. For least-squares fitting, this value gives the sum of squared deviations between PSF model and data in photons squared. For MLE fitting, this value gives the total likelihood score. In both cases, the value is not normed in any way and unlikely to be comparable between measurements.</entry></row>
                  <row><entry>fluo</entry><entry>dimensionless</entry><entry>scalar</entry><entry>Fluorophore type (0 for first fluorophore, 1 for second, etc.)</entry></row>
                  <row><entry>bg</entry><entry>ADC</entry><entry>scalar</entry><entry>Local background intensity</entry></row>
               </tbody>
         </tgroup>
      </table>
      <table id="ExpressionFilter_VariableModifiers">
         <title>Variable name modifiers for expressions</title>
         <tgroup cols='2' align='left' colsep='1' rowsep='1'>
               <thead><row><entry>Modifier</entry><entry>Meaning</entry></row></thead>
               <tbody>
                  <row><entry><replaceable>&hellip;</replaceable>x</entry><entry>&hellip; in X dimension</entry></row>
                  <row><entry><replaceable>&hellip;</replaceable>y</entry><entry>&hellip; in Y dimension</entry></row>
                  <row><entry><replaceable>&hellip;</replaceable>z</entry><entry>&hellip; in Z dimension</entry></row>
                  <row><entry>sigma<replaceable>&hellip;</replaceable></entry><entry>uncertainty of &hellip;</entry></row>
                  <row><entry><replaceable>&hellip;</replaceable>min</entry><entry>lower bound of &hellip;</entry></row>
                  <row><entry><replaceable>&hellip;</replaceable>max</entry><entry>upper bound of &hellip;</entry></row>
               </tbody>
         </tgroup>
      </table>
      <table id="ExpressionFilter_VariableExamples">
         <title>Variable example names for expressions</title>
         <tgroup cols='2' align='left' colsep='1' rowsep='1'>
               <thead><row><entry>Example variable name</entry><entry>Meaning</entry></row></thead>
               <tbody>
                  <row><entry>posx</entry><entry>Localization's X coordinate</entry></row>
                  <row><entry>posminy</entry><entry>Highest possible Y localization coordinate</entry></row>
                  <row><entry>fluo</entry><entry>Fluorophore type</entry></row>
               </tbody>
         </tgroup>
      </table>
      <table id="ExpressionFilter_Operators">
         <title>Operators in expressions</title>
         <tgroup cols="3">
               <colspec colnum="2" colwidth="6em"/>
               <thead><row><entry>Operator</entry><entry>Result type</entry><entry>Meaning</entry></row></thead>
               <tbody>
                  <row><entry><userinput>(<replaceable>n1</replaceable>)</userinput></entry><entry>numerical</entry><entry>grouping of numerical expressions</entry></row>
                  <row><entry><userinput><replaceable>n1</replaceable>^<replaceable>n2</replaceable></userinput></entry><entry>numerical</entry><entry>exponentiation</entry></row>
                  <row><entry><userinput><replaceable>n1</replaceable> * <replaceable>n2</replaceable>, <replaceable>n1</replaceable> / <replaceable>n2</replaceable></userinput></entry><entry>numerical</entry><entry>multiplication, division</entry></row>
                  <row><entry><userinput><replaceable>n1</replaceable> + <replaceable>n2</replaceable>, <replaceable>n1</replaceable> - <replaceable>n2</replaceable></userinput></entry><entry>numerical</entry><entry>addition, subtraction</entry></row>
                  <row><entry><userinput>(<replaceable>b1</replaceable>) ? <replaceable>n1</replaceable> : <replaceable>n2</replaceable></userinput></entry><entry>numerical</entry><entry>choice operator (if <replaceable>b1</replaceable> is true, use <replaceable>n1</replaceable>, else <replaceable>n2</replaceable></entry></row>
                  <row><entry><userinput><replaceable>n1</replaceable> == <replaceable>n2</replaceable>, <replaceable>n1</replaceable> != <replaceable>n2</replaceable>, <replaceable>n1</replaceable> = <replaceable>n2</replaceable>, <replaceable>n1</replaceable> &gt;= <replaceable>n2</replaceable>, <replaceable>n1</replaceable> &lt;= <replaceable>n2</replaceable>, <replaceable>n1</replaceable> &gt; <replaceable>n2</replaceable>, <replaceable>n1</replaceable> &lt; <replaceable>n2</replaceable></userinput></entry><entry>boolean</entry><entry>comparison for equality, inequality, equality (same as <userinput>==</userinput>), greater-equality, less-equality, greater, less</entry></row>
                  <row><entry><userinput>!<replaceable>b1</replaceable></userinput></entry><entry>boolean</entry><entry>negation</entry></row>
                  <row><entry><userinput><replaceable>b1</replaceable> &amp;&amp; <replaceable>b2</replaceable></userinput></entry><entry>boolean</entry><entry>conjunction (and)</entry></row>
                  <row><entry><userinput><replaceable>b1</replaceable> || <replaceable>b2</replaceable></userinput></entry><entry>boolean</entry><entry>disjunction (or)</entry></row>
               </tbody>
         </tgroup>
      </table>
      <table id="ExpressionFilter_ExampleActions">
         <title>Example actions</title>
         <tgroup cols="3">
               <colspec colnum="1" colwidth="4em"/>
               <thead><row><entry>Value to assign to</entry><entry>Expression to assign from</entry><entry>Intention</entry></row></thead>
               <tbody>
                  <row><entry>Filter</entry><entry><userinput>fluo = 0</userinput></entry><entry>Only show localizations from the first fluorophore</entry></row>
                  <row><entry>Filter</entry><entry><userinput>posx &gt; 1 um</userinput></entry><entry>Only show localizations right of a line at 1 &mgr;m</entry></row>
                  <row><entry>Filter</entry><entry><userinput>amp &lt; 5 kADC</userinput></entry><entry>Discard emissions with intensities above 5000 counts</entry></row>
                  <row><entry>Filter</entry><entry><userinput>posx &gt; 2300 nm &amp;&amp; posx &lt; 2800 nm &amp;&amp; posy &gt; 1800 nm &amp;&amp; posy &lt; 2200 nm &amp;&amp; frame &lt; 500 fr</userinput></entry><entry>Limit region of interest to a single bead early in the acquisition to calibrate 3D</entry></row>
                  <row><entry>posz</entry><entry><userinput>8 nm/fr * frame</userinput></entry><entry>Set a Z ground truth raising 8 nanometre per frame</entry></row>
                  <row><entry>amp</entry><entry><userinput>(fluo == 0) ? 1.5 * amp : 1 * amp</userinput></entry><entry>Make all localizations from the first fluorophore type more intense by a half</entry></row>
               </tbody>
         </tgroup>
      </table>
   </refentry>

</chapter>
